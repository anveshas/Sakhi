<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sakhi — Demo</title>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#071034">
  <!-- Icons and mobile/install metadata -->
  <link rel="icon" type="image/png" href="/static/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/static/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/static/icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sakhi">
  <style>
    :root{--accent:#e11d48;--bg:#071034;--muted:#94a3b8}
    html,body{height:100%;margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#071034 0%,#041024 100%);color:#e6eef8;display:flex;align-items:center;justify-content:center}
    .container{width:100%;max-width:560px;padding:24px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(2,6,23,0.6)}
    .top-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logo{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:linear-gradient(135deg,#ff758c,#e11d48)}
    .logo-img{width:100%;height:100%;object-fit:cover;display:block}
    h2{margin:0 0 6px 0;font-size:22px}
    p{color:var(--muted);margin:0 0 14px 0}
    .controls{display:flex;gap:12px}
    button{flex:1;padding:14px 16px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:white}
    .btn-muted{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    #status{margin-top:12px;color:var(--muted)}
    #result{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;color:#dff3ff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);color:var(--muted);font-size:13px}
    .danger{color:#ffb4c3}
    .small{font-size:13px;color:var(--muted)}
    .small-muted{font-size:13px;color:var(--muted)}
    .countdown{font-weight:700;color:#ffd6e0}
  </style>
</head>
<body>
  <div class="container">
    <div class="top-row">
      <div class="logo">
        <img src="/static/icon-192.png" alt="Sakhi" class="logo-img">
      </div>
      <div>
        <h2>Sakhi</h2>
        <div class="small-muted">Quick demo — capture a short clip and send for analysis</div>
      </div>
    </div>

    <p>Record a short clip (3–8s). Allow microphone and location when prompted. When a distressing emotion is detected the server may send alerts to your emergency contacts.</p>

    <div class="controls">
      <button id="record" class="btn-primary">Record</button>
      <button id="stop" class="btn-muted" disabled>Stop</button>
    </div>

    <div id="status" class="small">Ready</div>
    <div id="result" aria-live="polite"></div>

    <div style="margin-top:14px; display:flex;gap:10px;align-items:center;">
      <label class="small-muted" style="display:flex;gap:8px;align-items:center"><input id="autoAlert" type="checkbox" checked> Auto-send alert</label>
      <button id="testAlert" class="btn-muted" style="flex:0 0 auto">Send test</button>
    </div>
  </div>

<script>
let mediaRecorder, recordedChunks = [];
const recordBtn = document.getElementById('record');
const stopBtn = document.getElementById('stop');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');

let countdownTimer = null;

recordBtn.onclick = async () => {
  recordedChunks = [];
  resultEl.innerHTML = '';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = handleStop;
    mediaRecorder.start();
    recordBtn.disabled = true;
    stopBtn.disabled = false;
    startCountdown(8); // 8s auto-stop with visible countdown
  } catch (e) {
    statusEl.innerText = 'Microphone access denied or not available.';
  }
}

stopBtn.onclick = () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  stopBtn.disabled = true;
}

function startCountdown(seconds){
  let s = seconds;
  statusEl.innerHTML = `Recording — <span class="countdown">${s}s</span>`;
  countdownTimer = setInterval(() => {
    s -= 1;
    statusEl.innerHTML = `Recording — <span class="countdown">${s}s</span>`;
    if (s <= 0){
      clearInterval(countdownTimer);
    }
  }, 1000);
}

async function handleStop(){
  if (countdownTimer) clearInterval(countdownTimer);
  statusEl.innerText = 'Preparing upload...';
  stopBtn.disabled = true;
  await upload();
}

async function upload(){
  statusEl.innerText = 'Getting location...';
  let lat=null, lon=null;
  try{
    await new Promise((res) => navigator.geolocation.getCurrentPosition(p => { lat=p.coords.latitude; lon=p.coords.longitude; res(); }, () => { res(); }, {timeout:5000}));
  }catch(e){ }

  statusEl.innerText = 'Uploading...';
  const blob = new Blob(recordedChunks, { type: 'audio/webm' });
  const fd = new FormData();
  fd.append('audio', blob, 'clip.webm');
  if(lat) fd.append('lat', lat);
  if(lon) fd.append('lon', lon);
  fd.append('auto_alert', document.getElementById('autoAlert').checked ? 'true' : 'false');

  try{
    const resp = await fetch('/api/predict', { method: 'POST', body: fd });
    let json;
    const text = await resp.text();
    try{ json = JSON.parse(text); } catch(e){ json = null; }
    if (!resp.ok){
      const msg = json && json.error ? json.error : `Server returned ${resp.status}`;
      statusEl.innerText = '';
      resultEl.innerHTML = `<div class="danger">Error: ${msg}</div>`;
    } else if (json && json.emotion){
      statusEl.innerText = '';
      resultEl.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="badge">Emotion</div><div><strong style="font-size:18px;margin-left:6px">${json.emotion}</strong><div class="small-muted">Score: ${json.score ?? 'N/A'}</div></div></div>
        <div style="margin-top:8px" class="small-muted">Alert sent: ${json.alert_sent ? 'Yes' : 'No'}</div>`;
    } else {
      statusEl.innerText = '';
      resultEl.innerHTML = `<div class="danger">Unexpected response from server</div><pre class="small">${text}</pre>`;
    }
  }catch(e){
    statusEl.innerText = '';
    resultEl.innerHTML = `<div class="danger">Upload failed: ${e}</div>`;
  }
  recordBtn.disabled = false;
}

// test alert button (sends a small request with empty audio to trigger alert flow)
document.getElementById('testAlert').onclick = async () => {
  resultEl.innerText = 'Sending test alert...';
  const fd = new FormData();
  // small silent blob (1 byte) to avoid server file errors
  fd.append('audio', new Blob([new Uint8Array([0])]), 'silent.webm');
  fd.append('auto_alert', 'true');
  try{
    const resp = await fetch('/api/predict', { method: 'POST', body: fd });
    const json = await resp.json();
    resultEl.innerText = json.alert_sent ? 'Test alert attempted' : 'No contacts configured';
  }catch(e){ resultEl.innerText = 'Test failed: '+e }
}
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/static/service-worker.js').then(reg => {
      console.log('ServiceWorker registered', reg);
    }).catch(err => console.warn('SW register failed', err));
  });
}
</script>
</body>
</html>